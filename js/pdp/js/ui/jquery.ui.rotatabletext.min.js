function convertTextToCanvasRotate(e,t,n,r){var i,s,o,u;var a=r*Math.PI/180;var f=Math.cos(a);var l=Math.sin(a);if(l<0){l=-l}if(f<0){f=-f}i=n*l+t*f;s=n*f+t*l;var c=document.createElement("canvas");c.width=i;c.height=s;var h=c.getContext("2d");h.translate(i/2,s/2);h.rotate(-r*Math.PI/180);h.drawImage(e,-o/2,-u/2,o,u);return c}(function(e){e.fn.rotatabletext=function(t){var n={rotatorClass:"ui-rotatable-handle",mtx:[1,0,0,1]},r=e.extend(n,t),s=this,o;this.intialize=function(){this.createHandler();dims={w:s.width(),h:s.height()};this.updateRotationMatrix(r.mtx)};this.createHandler=function(){o=e('<div class="'+r.rotatorClass+'"></div>');s.append(o);this.bindRotation()};this.bindRotation=function(){o.draggable({revert:false,start:function(e){e.stopPropagation();e.stopImmediatePropagation();tl_coords={x:parseInt(s.parent().css("left")),y:parseInt(s.parent().css("top"))};dims={w:s.width(),h:s.height()};center_coords={x:s.offset().left+s.width()*.5,y:s.offset().top+s.height()*.5};begin_angle_pos={x:s.offset().left+s.width(),y:s.offset().top};begin_angle=s.radToDeg(s.getAngle(begin_angle_pos,center_coords));old_angle=s.attr("angle2");id=s.find("img").attr("rel")},drag:function(e){e.stopPropagation();e.stopImmediatePropagation();mouse_coords={x:e.pageX,y:e.pageY};angle=s.radToDeg(s.getAngle(mouse_coords,center_coords))-begin_angle;s.attr("angle",angle);new_angle=parseFloat(old_angle)+angle;s.attr("angle2",new_angle);return s.rotate(angle)},stop:function(e,t){var n=s.width(),r=s.height(),i=document.getElementById(id),o=convertTextToCanvasRotate(i,120,120,new_angle),u=convertCanvasToImage(o),a=convertImageToCanvas(u);s.find("img").remove();s.prepend(u);s.find("img").attr("rel",id)}})};this.getAngle=function(e,t){var n=e.x-t.x,r=-e.y+t.y,i=Math.sqrt(Math.pow(n,2)+Math.pow(r,2)),s=Math.acos(n/i);if(r<0){s=2*Math.PI-s}return s};this.degToRad=function(e){return e*(Math.PI/180)};this.radToDeg=function(e){return e*(180/Math.PI)};this.rotate=function(e){var t=Math.cos(s.degToRad(-e)),n=Math.sin(s.degToRad(-e)),r=[t,n,-n,t];this.updateRotationMatrix(r)};this.getRotationMatrix=function(){var e=s.css("transform")?s.css("transform"):"matrix(1, 0, 0, 1, 0, 0)";_m=e.split(","),m=[];for(i=0;i<4;i++){m[i]=parseFloat(_m[i].replace("matrix(",""))}return m};this.updateRotationMatrix=function(e){var t="matrix("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", 0, 0)",n="progid:DXImageTransform.Microsoft.Matrix(M11='"+e[0]+"', M12='"+e[1]+"', M21='"+e[2]+"', M22='"+e[3]+"', sizingMethod='auto expand')";s.find("img").css({"-moz-transform":t,"-o-transform":t,"-webkit-transform":t,"-ms-transform":t,transform:t,filter:n,"-ms-filter":'"'+n+'"'})};return this.intialize()}})(jQuery)