function convertCanvasToImage(e){var t=new Image;t.src=e.toDataURL("image/png");return t}function convertImageToCanvas(e,t,n){var r=document.createElement("canvas");r.width=t;r.height=n;context=r.getContext("2d");context.drawImage(e,0,0,t,n);return r}function convertTextToCanvas(e){var t=document.createElement("canvas");context=t.getContext("2d");context.fillStyle="#f00";context.font="italic bold 30px Arial";context.textBaseline="middle";context.strokeText(e,10,10);return t}function convertImageToCanvasRotate(e,t,n,r){var i,s,o,u;if(r==90){r=89.9999999999}var a=r*Math.PI/180;var f=Math.cos(a);var l=Math.sin(a);if(f<0){f=-f}if(l<0){l=-l}i=n*l+t*f;s=n*f+t*l;if(r%45==0&&r%90!=0){o=t/2;u=n/2}else{if(r%90==0){o=t;u=n}else{o=1/(f*f-l*l)*(t*f-n*l);u=1/(f*f-l*l)*(-t*l+n*f)}}if(o<0)o=-o;if(u<0)u=-u;if(i>=s){s=i}else{i=s}var c=document.createElement("canvas");c.width=i;c.height=s;var h=c.getContext("2d");h.translate(i/2,s/2);h.rotate(-r*Math.PI/180);h.drawImage(e,-t/2,-n/2,t,n);return c}(function(e){e.fn.rotatable=function(t){var n={rotatorClass:"ui-rotatable-handle",mtx:[1,0,0,1]},r=e.extend(n,t),s=this,o="http://50.63.117.232/~magentos/designs/",u;this.intialize=function(){this.createHandler();dims={w:s.width(),h:s.height()};this.updateRotationMatrix(r.mtx)};this.createHandler=function(){u=e('<div class="'+r.rotatorClass+'"></div>');s.append(u);this.bindRotation()};this.bindRotation=function(){u.draggable({revert:true,start:function(e){e.stopPropagation();e.stopImmediatePropagation();tl_coords={x:parseInt(s.parent().css("left")),y:parseInt(s.parent().css("top"))};dims={w:s.width(),h:s.height()};center_coords={x:s.offset().left+s.width()*.5,y:s.offset().top+s.height()*.5};begin_angle_pos={x:s.offset().left+s.width(),y:s.offset().top};begin_angle=s.radToDeg(s.getAngle(begin_angle_pos,center_coords));old_angle=s.attr("angle2");id=s.find("img").attr("rel")},drag:function(e){e.stopPropagation();e.stopImmediatePropagation();mouse_coords={x:e.pageX,y:e.pageY};angle=s.radToDeg(s.getAngle(mouse_coords,center_coords))-begin_angle;s.attr("angle",angle);new_angle=parseFloat(old_angle)+angle;s.attr("angle2",new_angle);return s.rotate(angle)},stop:function(e,t){var n=s.attr("w"),r=s.attr("h");var i=document.getElementById(id),o=convertImageToCanvasRotate(i,n,r,new_angle),u=convertCanvasToImage(o),a=convertImageToCanvas(u);s.find("img").remove();s.prepend(u);s.find("img").width("100%").attr("rel",id);s.height("auto")}})};this.getAngle=function(e,t){var n=e.x-t.x,r=-e.y+t.y,i=Math.sqrt(Math.pow(n,2)+Math.pow(r,2)),s=Math.acos(n/i);if(r<0){s=2*Math.PI-s}return s};this.degToRad=function(e){return e*(Math.PI/180)};this.radToDeg=function(e){return e*(180/Math.PI)};this.rotate=function(e){var t=Math.cos(s.degToRad(-e)),n=Math.sin(s.degToRad(-e)),r=[t,n,-n,t];this.updateRotationMatrix(r)};this.getRotationMatrix=function(){var e=s.css("transform")?s.css("transform"):"matrix(1, 0, 0, 1, 0, 0)";_m=e.split(","),m=[];for(i=0;i<4;i++){m[i]=parseFloat(_m[i].replace("matrix(",""))}return m};this.updateRotationMatrix=function(e){var t="matrix("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", 0, 0)",n="progid:DXImageTransform.Microsoft.Matrix(M11='"+e[0]+"', M12='"+e[1]+"', M21='"+e[2]+"', M22='"+e[3]+"', sizingMethod='auto expand')";s.find("img").css({"-moz-transform":t,"-o-transform":t,"-webkit-transform":t,"-ms-transform":t,transform:t,filter:n,"-ms-filter":'"'+n+'"'})};return this.intialize()}})(jQuery)